<!--
    Main index page for the captures.
    Runs multiple operations dependent on the URL and query string.
-->

<head>
    
    <!-- External Resources -->
    
    <script src="https://cdn.maptiler.com/ol/v6.12.0/ol.js"></script>
    <script src="https://cdn.maptiler.com/ol-mapbox-style/v6.8.3/olms.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" href="https://cdn.maptiler.com/ol/v6.12.0/ol.css">
    <style>
        #map, #img {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #finder {
            width : 400px;
            height: 400px;
            position: absolute;
            left: calc(50% - 200px);
            top: calc(50% - 200px);
            border: 4px solid rgb(255, 38, 0);
            display: none;
            pointer-events: none;
        }
        body {
            margin: 0;
            padding: 0;
        }
    </style>

    <!-- Internal Resources -->
    <script>

        let map = 0
        let recorded_sizing = {}
        let is_sizing = false

        const queryString = window.location.search
        const parameters = new URLSearchParams(queryString)
            
        const sent_lat = +parameters.get('lat') || -74.0059413
        const sent_lng = +parameters.get('lng') || 40.7127837
        const sent_zoom = +parameters.get('zoom') || 12

        const keys = {
            LEFTSHIFT: 16,
            KEY_S: 83,
            KEY_N: 78,
            KEY_I: 73,
            RETURN: 13
        }
        
        function describe ( ) {
            a = ol.proj.toLonLat( map.getView().getCenter() )
            return {
                lng : a[0],
                lat : a[1],
                zoom : map.getView().A.zoom
            }
        }

        function jump_to ( lat, lng, zoom ) {
            map.getView().setCenter(ol.proj.transform([lat, lng], 'EPSG:4326', 'EPSG:3857'));
            map.getView().setZoom(zoom);
        }

        // Run map itselef
        function initMap() {

            var styleJson = 'https://api.maptiler.com/maps/openstreetmap/style.json?key=a8pvGnJGI7rkOKPR0zDE';
            map = new ol.Map({
                    target: 'map',
                    view: new ol.View({
                    constrainResolution: true,
                    center: ol.proj.fromLonLat([sent_lat, sent_lng ]),
                    zoom: sent_zoom,
                    controls: []
                })
            });
            olms.apply(map, styleJson);
            map.getControls().forEach(function(control) {
                map.removeControl(control);
            }, this);

            // Load functionality on keypress
            window.onkeydown = function(e) {

                // Log info on I
                if (e.keyCode == keys.KEY_I) {
                    console.log(describe())
                }

                // Left-shift allows you to enter a lat-lng to teleport to
                if (e.keyCode == keys.LEFTSHIFT) {

                    // set map position basted on prompt
                    let center = prompt("Where to?")
                    let [a,b] = center.split(',')
                    
                    let lat = a.replace(/[^0-9\.\-]/g, '')
                    let lng = b.replace(/[^0-9\.\-]/g, '')

                    if (a.includes('S')) { lat = -(+lat) }
                    if (b.includes('W')) { lng = -(+lng) }

                    jump_to(+lat, +lng, describe().zoom)
                }

                // S allows you to take a picture of the current view
                if (e.keyCode == keys.KEY_S) {

                    const d = describe();

                    fetch('/capture', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            state: 'debug',
                            state_code: 'NAN',
                            city_name: 'debugsville',
                            chosen_lat: d.lat,
                            chosen_lng: d.lng,
                            zoom: d.zoom + 1
                        })
                    });
                }

                // N jumps to next city that needs charting
                if (e.keyCode == keys.KEY_N) {
                    fetch('/next', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(res => res.json()).then(data => {
                        document.getElementById('finder').style.display = 'block'
                        recorded_sizing = data
                        is_sizing = true
                        jump_to(+data.latitude, +data.longitude, data.zoom)
                    });
                }

                // Record the current view as valid
                if (e.keyCode == keys.RETURN) {

                    const center = describe().center;

                    if ( is_sizing ) {

                        is_sizing = false
                        document.getElementById('finder').style.display = 'none'

                        // Record the current view as valid for the api
                        fetch('/record', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                ...recorded_sizing,
                                chosen_lat: center[0],
                                chosen_lng: center[1],
                                zoom: 15 + (map.getZoom()-11)
                            })
                        })
                    }
                }
            };
        }
        setTimeout(initMap, 500)
    </script>
</head>

<body>
    <div id="map"></div>
    <div id="finder"></div>
</body>
